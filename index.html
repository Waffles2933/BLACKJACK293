<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Blackjack Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0b1220;color:#e6eef8;display:flex;flex-direction:column;align-items:center;padding:20px;position:relative;transition:background 0.3s,color 0.3s;}
body.light{background:#f0f0f0;color:#000;}
h1{text-align:center;margin-bottom:10px;}
.table{width:90%;max-width:1000px;background:#0f1724;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);margin-bottom:20px;}
body.light .table{background:#fff;color:#000;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.hand{background:#071026;padding:10px;border-radius:8px;margin-bottom:12px;position:relative;transition:border 0.2s;}
body.light .hand{background:#e0e0e0;}
.cards{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.card{width:50px;height:70px;border-radius:6px;background:#fff;color:#000;display:flex;flex-direction:column;justify-content:space-between;padding:4px;font-weight:700;text-align:center;transition:transform 0.2s;}
.card.animate{transform:translateY(-10px);}
.controls{display:flex;gap:6px;justify-content:center;margin:10px 0;flex-wrap:wrap;}
button{padding:6px 10px;border-radius:6px;border:none;background:#0ea5a6;color:#042027;font-weight:700;cursor:pointer;}
button:disabled{opacity:0.5;cursor:default;}
.status{text-align:center;font-weight:700;margin:8px 0;}
.score{font-weight:900;color:#9ad1d1;font-size:20px;}
body.light .score{color:#0a9396;}
.bet-chips{text-align:center;margin-bottom:8px;}
input[type=number]{width:60px;padding:4px;border-radius:4px;border:none;font-weight:700;}
#keySettingsBtn,#themeToggleBtn{position:absolute;top:10px;padding:6px 10px;font-weight:700;}
#keySettingsBtn{right:120px;background:#facc15;color:#042027;}
#themeToggleBtn{right:10px;background:#94a3b8;color:#042027;}
#keyModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;}
.modal-content{background:#0f1724;padding:20px;border-radius:10px;display:flex;flex-direction:column;gap:8px;}
.modal-content input{width:60px;padding:4px;border-radius:4px;border:none;font-weight:700;}
.notification{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 30px;font-size:28px;font-weight:900;color:#f00;background:rgba(255,255,255,0.1);border-radius:12px;pointer-events:none;opacity:0;transition:opacity 0.5s;}
.chip-stack{display:inline-block;width:30px;height:15px;margin:0 1px;background:red;border-radius:50%;vertical-align:middle;}
#stats{margin-top:10px;font-size:14px;text-align:center;}
#dealerHistory{margin-bottom:6px;font-size:14px;text-align:center;}
</style>
</head>
<body>

<h1>Blackjack Ultimate</h1>
<button id="keySettingsBtn">Custom Keys</button>
<button id="themeToggleBtn">Toggle Theme</button>

<div class="bet-chips">
  Chips: <span id="chips">1000</span> | Bet: <input type="number" id="betInput" min="1" max="1000" value="10">
  <button id="preset10">10</button>
  <button id="preset50">50</button>
  <button id="preset100">100</button>
</div>

<div id="dealerHistory">Dealer Last Cards: </div>

<div class="table" id="dealerPanel">
  <div class="hand">
    <strong>Dealer</strong> <span class="score" id="dealerScore">—</span>
    <div class="cards" id="dealerCards"></div>
  </div>
</div>

<div class="table" id="playerPanel"></div>

<div class="controls">
  <button id="dealBtn">Deal</button>
  <button id="hitBtn" disabled>Hit</button>
  <button id="standBtn" disabled>Stand</button>
  <button id="doubleBtn" disabled>Double Down</button>
  <button id="splitBtn" disabled>Split</button>
  <button id="insuranceBtn" disabled>Insurance</button>
  <button id="surrenderBtn" disabled>Surrender</button>
  <button id="restartBtn">Restart</button>
</div>

<div class="status" id="status">Set your bet and press Deal.</div>
<div id="stats">Wins: 0 | Losses: 0 | Blackjacks: 0</div>
<div id="notification" class="notification"></div>

<!-- Key modal -->
<div id="keyModal">
  <div class="modal-content">
    <label>Hit: <input id="keyHit" maxlength="1" value="h"></label>
    <label>Stand: <input id="keyStand" maxlength="1" value="s"></label>
    <label>Double: <input id="keyDouble" maxlength="1" value="d"></label>
    <label>Split: <input id="keySplit" maxlength="1" value="p"></label>
    <label>Redeal: <input id="keyRedeal" maxlength="1" value="r"></label>
    <button id="saveKeysBtn">Save Keys</button>
  </div>
</div>

<script>
// --- Variables ---
const SUITS=['♠','♥','♦','♣'],RANKS=[{r:'A',value:11},{r:'2',value:2},{r:'3',value:3},{r:'4',value:4},{r:'5',value:5},{r:'6',value:6},{r:'7',value:7},{r:'8',value:8},{r:'9',value:9},{r:'10',value:10},{r:'J',value:10},{r:'Q',value:10},{r:'K',value:10}];
let deck=[],dealer=[],playerHands=[],currentHandIndex=0,gameOver=true,chips=1000,stats={wins:0,losses:0,blackjacks:0},dealerHistory=[];
let keyMap={hit:'h',stand:'s',double:'d',split:'p',redeal:'r'};

const dealerCardsEl=document.getElementById('dealerCards');
const dealerScoreEl=document.getElementById('dealerScore');
const playerPanelEl=document.getElementById('playerPanel');
const statusEl=document.getElementById('status');
const chipsEl=document.getElementById('chips');
const betInput=document.getElementById('betInput');
const dealBtn=document.getElementById('dealBtn');
const hitBtn=document.getElementById('hitBtn');
const standBtn=document.getElementById('standBtn');
const doubleBtn=document.getElementById('doubleBtn');
const splitBtn=document.getElementById('splitBtn');
const restartBtn=document.getElementById('restartBtn');
const insuranceBtn=document.getElementById('insuranceBtn');
const surrenderBtn=document.getElementById('surrenderBtn');
const keySettingsBtn=document.getElementById('keySettingsBtn');
const keyModal=document.getElementById('keyModal');
const saveKeysBtn=document.getElementById('saveKeysBtn');
const notificationEl=document.getElementById('notification');
const statsEl=document.getElementById('stats');
const dealerHistoryEl=document.getElementById('dealerHistory');
const themeToggleBtn=document.getElementById('themeToggleBtn');
const preset10=document.getElementById('preset10');
const preset50=document.getElementById('preset50');
const preset100=document.getElementById('preset100');

// --- Utility ---
function buildDeck(){const d=[];for(const s of SUITS)for(const r of RANKS)d.push({suit:s,rank:r.r,value:r.value});return d;}
function shuffle(deck){for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}}
function dealCard(to){if(deck.length===0){deck=buildDeck();shuffle(deck);}const card=deck.pop();to.push(card);return card;}
function calculateScore(hand){let sum=0,aces=0;for(const c of hand){sum+=c.value;if(c.rank==='A')aces++;}while(sum>21&&aces>0){sum-=10;aces--;}return sum;}
function renderCard(card,hidden=false){const div=document.createElement('div');div.className='card'+(hidden?' hidden-card':'');div.innerHTML=`<div>${hidden?'&nbsp;':card.rank}</div><div>${hidden?'&nbsp;':card.suit}</div><div>${hidden?'&nbsp;':card.rank}</div>`;return div;}
function showNotification(msg,color='#f00'){notificationEl.textContent=msg;notificationEl.style.color=color;notificationEl.style.opacity=1;setTimeout(()=>notificationEl.style.opacity=0,800);}
function updateChips(){chipsEl.textContent=chips;}
function saveChips(){localStorage.setItem('bjChips',chips);}
function loadChips(){const v=localStorage.getItem('bjChips');if(v!==null)chips=parseInt(v);updateChips();}
function updateStats(){statsEl.textContent=`Wins: ${stats.wins} | Losses: ${stats.losses} | Blackjacks: ${stats.blackjacks}`;}
function updateDealerHistory(){dealerHistoryEl.textContent='Dealer Last Cards: '+dealerHistory.map(c=>c.rank+c.suit).join(' ');}
function animateCard(cardEl){cardEl.classList.add('animate');setTimeout(()=>cardEl.classList.remove('animate'),200);}
function toggleTheme(){document.body.classList.toggle('light');}

// --- Rendering ---
function renderDealer(showAll=false){dealerCardsEl.innerHTML='';dealer.forEach((c,i)=>{const hidden=!showAll&&i===1;const cardEl=renderCard(c,hidden);dealerCardsEl.appendChild(cardEl);if(!hidden)animateCard(cardEl);});dealerScoreEl.textContent='Score: '+(showAll?calculateScore(dealer):'?');}
function renderPlayer(){playerPanelEl.innerHTML='';playerHands.forEach((hand,i)=>{const div=document.createElement('div');div.className='hand';div.innerHTML=`<strong>Hand ${i+1}</strong> <span class="score">${calculateScore(hand.cards)}</span>`;const cardsDiv=document.createElement('div');cardsDiv.className='cards';hand.cards.forEach(c=>{const cardEl=renderCard(c,false);cardsDiv.appendChild(cardEl);animateCard(cardEl);});div.appendChild(cardsDiv);if(i===currentHandIndex&&!hand.finished)div.style.border='3px solid #0ea5a6';playerPanelEl.appendChild(div);});}

// --- Preset bets ---
preset10.addEventListener('click',()=>{betInput.value=10;});
preset50.addEventListener('click',()=>{betInput.value=50;});
preset100.addEventListener('click',()=>{betInput.value=100;});

// --- Deal ---
function deal(){
    let bet=Math.min(Math.max(1,parseInt(betInput.value)||10),chips);
    chips-=bet;
    saveChips();
    playerHands=[{cards:[],bet:bet,finished:false,doubled:false}];
    currentHandIndex=0;
    dealer=[];
    deck=buildDeck();shuffle(deck);
    dealCard(playerHands[0].cards);
    dealCard(dealer);
    dealCard(playerHands[0].cards);
    dealCard(dealer);
    gameOver=false;
    renderDealer(false);
    renderPlayer();
    statusEl.textContent=`Playing hand 1`;
    toggleButtons();
    updateChips();
}

// --- Player Actions ---
function playerHit(){const hand=playerHands[currentHandIndex];dealCard(hand.cards);if(calculateScore(hand.cards)>=21)hand.finished=true;renderPlayer();toggleButtons();if(hand.finished)nextHand();}
function playerStand(){playerHands[currentHandIndex].finished=true;nextHand();}
function playerDouble(){const hand=playerHands[currentHandIndex];if(hand.cards.length===2&&chips>=hand.bet){chips-=hand.bet;hand.bet*=2;hand.doubled=true;dealCard(hand.cards);hand.finished=true;renderPlayer();updateChips();nextHand();}}
function playerSplit(){const hand=playerHands[currentHandIndex];if(hand.cards.length===2&&hand.cards[0].rank===hand.cards[1].rank&&playerHands.length<4&&chips>=hand.bet){chips-=hand.bet;const newHand={cards:[hand.cards.pop()],bet:hand.bet,finished:false,doubled:false};dealCard(hand.cards);dealCard(newHand.cards);playerHands.splice(currentHandIndex+1,0,newHand);renderPlayer();updateChips();toggleButtons();}}
function playerSurrender(){const hand=playerHands[currentHandIndex];chips+=Math.floor(hand.bet/2);hand.finished=true;renderPlayer();updateChips();nextHand();}
function playerInsurance(){showNotification('Insurance not implemented yet','#ff0');}

// --- Hand Management ---
function nextHand(){currentHandIndex++;if(currentHandIndex>=playerHands.length){dealerTurn();}else{statusEl.textContent=`Playing hand ${currentHandIndex+1}`;toggleButtons();renderPlayer();}}
function toggleButtons(){if(gameOver){dealBtn.disabled=false;hitBtn.disabled=true;standBtn.disabled=true;doubleBtn.disabled=true;splitBtn.disabled=true;insuranceBtn.disabled=true;surrenderBtn.disabled=true;}else{dealBtn.disabled=true;const hand=playerHands[currentHandIndex];hitBtn.disabled=hand.finished;standBtn.disabled=hand.finished;doubleBtn.disabled=hand.finished||hand.cards.length!==2||chips<hand.bet;splitBtn.disabled=hand.finished||hand.cards.length!==2||hand.cards[0].rank!==hand.cards[1].rank||playerHands.length>=4||chips<hand.bet;insuranceBtn.disabled=dealer[0].rank!=='A'||hand.finished;surrenderBtn.disabled=hand.finished||hand.cards.length!==2;}}
function dealerTurn(){renderDealer(true);let score=calculateScore(dealer);while(score<17||(score===17&&dealer.some(c=>c.rank==='A'&&calculateScore(dealer)<=17))){dealCard(dealer);renderDealer(true);score=calculateScore(dealer);}settleBets();}
function settleBets(){const dealerScore=calculateScore(dealer);dealerHistory.push(...dealer);if(dealerHistory.length>5)dealerHistory=dealerHistory.slice(-5);updateDealerHistory();let results=[];playerHands.forEach(hand=>{const s=calculateScore(hand.cards);if(s>21){results.push(`Hand busts. Lose ${hand.bet}`);stats.losses++;}else if(s===21&&hand.cards.length===2&&dealerScore!==21){chips+=hand.bet*2.5;results.push(`Blackjack! Win ${hand.bet*1.5}`);stats.blackjacks++;stats.wins++;}else if(dealerScore>21||s>dealerScore){chips+=hand.bet*2;results.push(`Win ${hand.bet}`);stats.wins++;}else if(s===dealerScore){chips+=hand.bet;results.push(`Push`);}else{results.push(`Lose ${hand.bet}`);stats.losses++;}});gameOver=true;updateChips();toggleButtons();renderDealer(true);statusEl.innerHTML=results.join('<br>');updateStats();saveChips();}

// --- Restart ---
restartBtn.addEventListener('click',()=>{chips=1000;saveChips();playerHands=[];dealer=[];gameOver=true;currentHandIndex=0;renderDealer(false);renderPlayer();statusEl.textContent="Set your bet and press Deal.";updateChips();toggleButtons();dealerHistory=[];updateDealerHistory();stats={wins:0,losses:0,blackjacks:0};updateStats();});

// --- Key Shortcuts ---
document.addEventListener('keydown',e=>{const key=e.key.toLowerCase();if(key===keyMap.hit)playerHit();else if(key===keyMap.stand)playerStand();else if(key===keyMap.double)playerDouble();else if(key===keyMap.split)playerSplit();else if(key===keyMap.redeal)deal();});

// --- Custom keys modal ---
keySettingsBtn.addEventListener('click',()=>{keyModal.style.display='flex';});
saveKeysBtn.addEventListener('click',()=>{keyMap.hit=document.getElementById('keyHit').value.toLowerCase();keyMap.stand=document.getElementById('keyStand').value.toLowerCase();keyMap.double=document.getElementById('keyDouble').value.toLowerCase();keyMap.split=document.getElementById('keySplit').value.toLowerCase();keyMap.redeal=document.getElementById('keyRedeal').value.toLowerCase();keyModal.style.display='none';});
keyModal.addEventListener('click',e=>{if(e.target===keyModal)keyModal.style.display='none';});

// --- Theme toggle ---
themeToggleBtn.addEventListener('click',toggleTheme);

// --- Load chips from storage ---
loadChips();
updateStats();
</script>
</body>
</html>
